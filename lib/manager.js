(function(Backbone, _, $, window) {
  var Manager, cachedParamMatcher, managerQueue, onloadUrl, _watchForStateChange;
  managerQueue = _.extend({}, Backbone.Events);
  onloadUrl = window.location.href;
  cachedParamMatcher = /\:([^:)/]+)/g;
  Manager = (function() {
    Manager.prototype.states = {};

    Manager.prototype.events = {};

    function Manager(router, options) {
      this.router = router;
      _.extend(this, Backbone.Events);
      this._parseStates();
      this._parseEvents();
      this.initialize(options);
      return;
    }

    Manager.prototype._parseStates = function() {
      _.each(_.keys(this.states), (function(_this) {
        return function(stateKey) {
          var stateOptions;
          stateOptions = _this.states[stateKey];
          if (!stateOptions.transitionMethod) {
            throw new Error(stateKey + ' needs transitionMethod definitions');
          }
          if (stateOptions.url) {
            stateOptions._urlParams = cachedParamMatcher.exec(stateOptions.url).slice(1);
            stateOptions._urlAsTemplate = _.template(stateOptions.url, null, {
              interpolate: cachedParamMatcher
            });
            stateOptions._urlAsRegex = stateOptions.url;
            if (!_.isRegExp(stateOptions._urlAsRegex)) {
              stateOptions._urlAsRegex = _this.router._routeToRegExp(stateOptions._urlAsRegex);
            }
            _this.router.route(stateOptions._urlAsRegex, stateKey, function() {
              var historyHasUpdated;
              if (onloadUrl && (window != null ? window.location.href : void 0) === onloadUrl) {
                _this._handleLoadCallback(stateKey, stateOptions, arguments);
              } else {
                _this._handleTransitionCallback(stateKey, stateOptions, arguments, historyHasUpdated = true);
              }
              onloadUrl = null;
            });
          }
          return _this.listenTo(managerQueue, stateKey, function(args) {
            _this._handleTransitionCallback(stateKey, stateOptions, args);
          });
        };
      })(this));
    };

    Manager.prototype._handleLoadCallback = function(stateKey, stateOptions, args) {
      if (!stateOptions.loadMethod) {
        throw new Error(stateKey + ' is being triggered for load, but no loadMethod has been defined');
      }
      this.trigger('pre-load');
      this.trigger('pre-load:' + stateKey, args);
      this[stateOptions.loadMethod].apply(this, args);
      this.trigger('post-load:' + stateKey, args);
      this.trigger('post-load');
    };

    Manager.prototype._handleTransitionCallback = function(stateKey, stateOptions, args, historyHasUpdated) {
      var argsObject, data, options, url;
      if (historyHasUpdated == null) {
        historyHasUpdated = false;
      }
      this.trigger('pre-transition');
      this.trigger('pre-transition:' + stateKey);
      if (stateOptions.url) {
        if (args instanceof Array) {
          argsObject = _.object(stateOptions._urlParams, args);
          url = stateOptions._urlAsTemplate(argsObject);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = args;
          data.push(null);
        } else if (args instanceof Object) {
          url = stateOptions._urlAsTemplate(args);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = this.router._extractParameters(stateOptions._urlAsRegex, url);
        } else {
          throw new Error('Args are only supported as an object or array if state.url is defined');
        }
        options = {
          url: url
        };
        data.push(options);
      } else {
        data = args;
      }
      this[stateOptions.transitionMethod].apply(this, data);
      this.trigger('post-transition:' + stateKey);
      this.trigger('post-transition');
    };

    Manager.prototype._parseEvents = function() {
      _.each(_.keys(this.events), (function(_this) {
        return function(eventName) {
          _this.on(eventName, function() {
            var eventFunction;
            eventFunction = _this.events[eventName];
            _this[eventFunction]();
          });
        };
      })(this));
    };

    return Manager;

  })();
  Backbone.Manager = Manager;
  Backbone.Manager.extend = Backbone.Model.extend;
  _watchForStateChange = function() {
    return $('body').on('click', function(event) {
      var args, state, stateInfo;
      if (!event.isDefaultPrevented()) {
        if ($(event.target).attr('x-bb-state')) {
          event.preventDefault();
          stateInfo = $(event.target).attr('x-bb-state').split('(', 2);
          state = stateInfo[0];
          args = stateInfo[1].slice(0, stateInfo[1].indexOf(')'));
          managerQueue.trigger(state, JSON.parse(args));
        }
      }
    });
  };
  $(_watchForStateChange);
})(Backbone, _, $, window);

//# sourceMappingURL=data:application/json;base64,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QUFBO0FBQUEsTUFBQSxJQUFBLENBQUEsS0FBWSxDQUFDLGtCQUFOLENBQUEsQ0FBUDtBQUNFLFFBQUEsSUFBRyxDQUFBLENBQUUsS0FBSyxDQUFDLE1BQVIsQ0FBZSxDQUFDLElBQWhCLENBQXFCLFlBQXJCLENBQUg7QUFDRSxVQUFBLEtBQUssQ0FBQyxjQUFOLENBQUEsQ0FBQSxDQUFBO0FBQUEsVUFDQSxTQUFBLEdBQVksQ0FBQSxDQUFFLEtBQUssQ0FBQyxNQUFSLENBQWUsQ0FBQyxJQUFoQixDQUFxQixZQUFyQixDQUFrQyxDQUFDLEtBQW5DLENBQXlDLEdBQXpDLEVBQThDLENBQTlDLENBRFosQ0FBQTtBQUFBLFVBRUEsS0FBQSxHQUFRLFNBQVUsQ0FBQSxDQUFBLENBRmxCLENBQUE7QUFBQSxVQUdBLElBQUEsR0FBTyxTQUFVLENBQUEsQ0FBQSxDQUFFLENBQUMsS0FBYixDQUFtQixDQUFuQixFQUFzQixTQUFVLENBQUEsQ0FBQSxDQUFFLENBQUMsT0FBYixDQUFxQixHQUFyQixDQUF0QixDQUhQLENBQUE7QUFBQSxVQUlBLFlBQVksQ0FBQyxPQUFiLENBQXFCLEtBQXJCLEVBQTRCLElBQUksQ0FBQyxLQUFMLENBQVcsSUFBWCxDQUE1QixDQUpBLENBREY7U0FERjtPQURvQjtJQUFBLENBQXRCLEVBRHFCO0VBQUEsQ0FqS3ZCLENBQUE7QUFBQSxFQTZLQSxDQUFBLENBQUUsb0JBQUYsQ0E3S0EsQ0FERDtBQUFBLENBQUQsQ0FBQSxDQWdMRSxRQWhMRixFQWdMWSxDQWhMWixFQWdMZSxDQWhMZixFQWdMa0IsTUFoTGxCLENBQUEsQ0FBQSIsImZpbGUiOiJtYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiKChCYWNrYm9uZSwgXywgJCwgd2luZG93KSAtPlxuICBtYW5hZ2VyUXVldWUgPSBfLmV4dGVuZCB7fSwgQmFja2JvbmUuRXZlbnRzXG4gIG9ubG9hZFVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmXG5cbiAgY2FjaGVkUGFyYW1NYXRjaGVyID0gL1xcOihbXjopL10rKS9nXG5cbiAgIyBNYW5hZ2VyKHJvdXRlcikgLSByb3V0ZXIgd2lsbCBiZSB3aGVyZSB0aGUgaGlzdG9yeSBuYXZpZ2F0aW9uIGlzIHB1c2hlZCB0aHJvdWdoXG4gICNcbiAgIyAgV2hlbiBzdGF0ZSBjaGFuZ2UgaXMgdHJpZ2dlcmVkOlxuICAjICAgIC0gcm91dGVyIG5hdmlnYXRlIG9jY3VycyBpZiB0aGUgc3RhdGUgaGFzIGFuIHVybFxuICAjICAgIC0gYXBwcm9wcmlhdGUgcHJlIGV2ZW50cyAobG9hZC90cmFuc2l0aW9uKSBhcmUgdHJpZ2dlcmVkLCBib3RoIGdlbmVyaWMgYW5kIHN0YXRlIHNwZWNpZmljXG4gICMgICAgLSBtYWtlIGNhbGwgdG8gbWV0aG9kXG4gICMgICAgLSBhcHByb3ByaWF0ZSBwb3N0IGV2ZW50cyAobG9hZC90cmFuc2l0aW9uKSBhcmUgdHJpZ2dlcmVkLCBib3RoIGdlbmVyaWMgYW5kIHN0YXRlIHNwZWNpZmljXG4gICNcbiAgIyAgVHJpZ2dlcmVkIEV2ZW50czpcbiAgIyAgICBwcmUtbG9hZCAgICAgICAgICAgICAgICAgLSBpbmRpY2F0ZXMgaW5jb21pbmcgcGFnZSBsb2FkIGNhbGwgZm9yIGFsbCBzdGF0ZXNcbiAgIyAgICBwcmUtbG9hZDpbc3RhdGVdIChhcmdzKSAgLSBpbmRpY2F0ZXMgaW5jb21pbmcgcGFnZSBsb2FkIGNhbGwgZm9yIHRoZSBzdGF0ZVxuICAjICAgIHBvc3QtbG9hZCAgICAgICAgICAgICAgICAtIGluZGljYXRlcyBpbmNvbWluZyBwYWdlIGxvYWQgY2FsbCBjb21wbGV0ZWQgZm9yIGFsbCBzdGF0ZXNcbiAgIyAgICBwb3N0LWxvYWQ6W3N0YXRlXSAoYXJncykgLSBpbmRpY2F0ZXMgaW5jb21pbmcgcGFnZSBsb2FkIGNhbGwgY29tcGxldGVkIGZvciB0aGUgc3RhdGVcbiAgI1xuICAjICAgIHByZS10cmFuc2l0aW9uICAgICAgICAgIC0gaW5kaWNhdGVzIGluY29taW5nIHRyYW5zaXRpb24gY2FsbCBmb3IgYWxsIHN0YXRlc1xuICAjICAgIHByZS10cmFuc2l0aW9uOltzdGF0ZV0gIC0gaW5kaWNhdGVzIGluY29taW5nIHRyYW5zaXRpb24gY2FsbCBmb3IgdGhlIHN0YXRlXG4gICMgICAgcG9zdC10cmFuc2l0aW9uICAgICAgICAgLSBpbmRpY2F0ZXMgdHJhbnNpdGlvbiBjYWxsIGNvbXBsZXRlZCBmb3IgYWxsIHN0YXRlc1xuICAjICAgIHBvc3QtdHJhbnNpdGlvbjpbc3RhdGVdIC0gaW5kaWNhdGVzIHRyYW5zaXRpb24gY2FsbCBjb21wbGV0ZWQgZm9yIHRoZSBzdGF0ZVxuICAjXG4gIGNsYXNzIE1hbmFnZXJcbiAgICAjIHN0YXRlIHN0cnVjdHVyZTpcbiAgICAjIHtcbiAgICAjICAgJ3VzZXJzJzoge1xuICAgICMgICAgIHVybDogJ3VzZXJzLzppZCcgKG9wdGlvbmFsKVxuICAgICMgICAgIGxvYWRNZXRob2Q6ICdnb1VzZXInIChvcHRpb25hbCkgIyBmdW5jdGlvbnMgbGlrZSByb3V0ZXIsIHdpbGwgYmUgY2FsbGVkIHdpdGggZ29Vc2VyKHtpZDogMX0pXG4gICAgIyAgICAgdHJhbnNpdGlvbk1ldGhvZDogJ21vdmVUb1VzZXInXG4gICAgIyAgIH1cbiAgICAjIH1cbiAgICAjXG4gICAgI1xuICAgIHN0YXRlczoge31cblxuICAgICMgZXZlbnQgc3RydWN0dXJlIGJhc2VkIG9uIGRlZmluZWQgTWFuYWdlciB0cmlnZ2VyZWQgZXZlbnRzXG4gICAgIyB7XG4gICAgIyAgICdwcmUtdHJhbnNpdGlvbjp1c2Vycyc6ICdzaG93QWxlcnQnXG4gICAgIyB9XG4gICAgZXZlbnRzOiB7fVxuXG4gICAgY29uc3RydWN0b3I6IChyb3V0ZXIsIG9wdGlvbnMpIC0+XG4gICAgICBAcm91dGVyID0gcm91dGVyXG4gICAgICBfLmV4dGVuZCBALCBCYWNrYm9uZS5FdmVudHNcbiAgICAgIEBfcGFyc2VTdGF0ZXMoKVxuICAgICAgQF9wYXJzZUV2ZW50cygpXG4gICAgICBAaW5pdGlhbGl6ZSBvcHRpb25zXG4gICAgICByZXR1cm5cblxuICAgIF9wYXJzZVN0YXRlczogLT5cbiAgICAgIF8uZWFjaCBfLmtleXMoQHN0YXRlcyksIChzdGF0ZUtleSkgPT5cbiAgICAgICAgc3RhdGVPcHRpb25zID0gQHN0YXRlc1tzdGF0ZUtleV1cblxuICAgICAgICB1bmxlc3Mgc3RhdGVPcHRpb25zLnRyYW5zaXRpb25NZXRob2RcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Igc3RhdGVLZXkrJyBuZWVkcyB0cmFuc2l0aW9uTWV0aG9kIGRlZmluaXRpb25zJ1xuXG4gICAgICAgIGlmIHN0YXRlT3B0aW9ucy51cmxcbiAgICAgICAgICBzdGF0ZU9wdGlvbnMuX3VybFBhcmFtcyA9IGNhY2hlZFBhcmFtTWF0Y2hlci5leGVjKHN0YXRlT3B0aW9ucy51cmwpLnNsaWNlKDEpXG4gICAgICAgICAgc3RhdGVPcHRpb25zLl91cmxBc1RlbXBsYXRlID0gXy50ZW1wbGF0ZSBzdGF0ZU9wdGlvbnMudXJsLCBudWxsLCB7aW50ZXJwb2xhdGU6IGNhY2hlZFBhcmFtTWF0Y2hlcn1cbiAgICAgICAgICBzdGF0ZU9wdGlvbnMuX3VybEFzUmVnZXggPSBzdGF0ZU9wdGlvbnMudXJsXG5cbiAgICAgICAgICB1bmxlc3MgXy5pc1JlZ0V4cChzdGF0ZU9wdGlvbnMuX3VybEFzUmVnZXgpXG4gICAgICAgICAgICBzdGF0ZU9wdGlvbnMuX3VybEFzUmVnZXggPSBAcm91dGVyLl9yb3V0ZVRvUmVnRXhwIHN0YXRlT3B0aW9ucy5fdXJsQXNSZWdleFxuXG4gICAgICAgICAgIyBSZWdpc3RlciB0aGUgdXJscyBpbnRvIHRoZSByb3V0ZXJcbiAgICAgICAgICBAcm91dGVyLnJvdXRlIHN0YXRlT3B0aW9ucy5fdXJsQXNSZWdleCwgc3RhdGVLZXksID0+XG5cbiAgICAgICAgICAgICMgT25seSBydW4gbG9hZENhbGxiYWNrIGlmIHRoaXMgaXMgdHJ1bHkgdGhlIHZlcnkgZmlyc3QgY2FsbGJhY2sgZnJvbSB0aGUgcGFnZWxvYWQgcG9wc3RhdGVcbiAgICAgICAgICAgICMgSW4gb3RoZXIgY2FzZXMsIEJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgcG90ZW50aWFsbHkgY2hhbmdlZCB0aGUgdXJsIGZvciByb3V0ZXIgbmF2LFxuICAgICAgICAgICAgIyBzbyB3ZSBjaGVjayBhZ2FpbnN0IGl0XG4gICAgICAgICAgICBpZiBvbmxvYWRVcmwgYW5kIHdpbmRvdz8ubG9jYXRpb24uaHJlZiBpcyBvbmxvYWRVcmwgIyB0b2RvIGE6IHZlcmlmeSB0aGlzIHdvcmtzIGNyb3NzIGJyb3dzZXIgJiB3LyBoYXNoXG4gICAgICAgICAgICAgIEBfaGFuZGxlTG9hZENhbGxiYWNrIHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGFyZ3VtZW50c1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICBAX2hhbmRsZVRyYW5zaXRpb25DYWxsYmFjayBzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmd1bWVudHMsIGhpc3RvcnlIYXNVcGRhdGVkID0gdHJ1ZVxuXG4gICAgICAgICAgICBvbmxvYWRVcmwgPSBudWxsXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAjIFN0YXJ0IGxpc3RlbmluZyBmb3Igb3VyIHN0YXRlIHRyYW5zaXRpb24gY2FsbHNcbiAgICAgICAgQGxpc3RlblRvIG1hbmFnZXJRdWV1ZSwgc3RhdGVLZXksIChhcmdzKSA9PlxuICAgICAgICAgIEBfaGFuZGxlVHJhbnNpdGlvbkNhbGxiYWNrIHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGFyZ3NcbiAgICAgICAgICByZXR1cm5cbiAgICAgIHJldHVyblxuXG4gICAgX2hhbmRsZUxvYWRDYWxsYmFjazogKHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGFyZ3MpIC0+XG4gICAgICB1bmxlc3Mgc3RhdGVPcHRpb25zLmxvYWRNZXRob2RcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yIHN0YXRlS2V5KycgaXMgYmVpbmcgdHJpZ2dlcmVkIGZvciBsb2FkLCBidXQgbm8gbG9hZE1ldGhvZCBoYXMgYmVlbiBkZWZpbmVkJ1xuXG4gICAgICBAdHJpZ2dlciAncHJlLWxvYWQnXG4gICAgICBAdHJpZ2dlciAncHJlLWxvYWQ6JytzdGF0ZUtleSwgYXJnc1xuICAgICAgQFtzdGF0ZU9wdGlvbnMubG9hZE1ldGhvZF0uYXBwbHkgdGhpcywgYXJnc1xuICAgICAgQHRyaWdnZXIgJ3Bvc3QtbG9hZDonK3N0YXRlS2V5LCBhcmdzXG4gICAgICBAdHJpZ2dlciAncG9zdC1sb2FkJ1xuICAgICAgcmV0dXJuXG5cbiAgICAjIFJlYWNoZWQgaW4gdHdvIHdheXM6XG4gICAgIyAgMSkgQ2FsbGJhY2sgZnJvbSByb3V0ZXIgcm91dGUgaGFuZGxlXG4gICAgIyAgICBhKSBhcmdzIGlzIGFuIGFycmF5IGZyb20gdGhlIHJvdXRlIGNhbGxiYWNrXG4gICAgIyAgMikgYmItc3RhdGUgY2hhbmdlIGNhbGxiYWNrXG4gICAgIyAgICBhKSBhcmdzIGlzIHdoYXQgdGhlIHVzZXIgaGFzIHByb3ZpZGVkIGRlY2xhcmF0aXZlbHksIG9yIGl0J3MgcGFyc2VkIGZyb20gdGhlIGxpbmsgdXJsXG4gICAgX2hhbmRsZVRyYW5zaXRpb25DYWxsYmFjazogKHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGFyZ3MsIGhpc3RvcnlIYXNVcGRhdGVkID0gZmFsc2UpIC0+XG4gICAgICBAdHJpZ2dlciAncHJlLXRyYW5zaXRpb24nXG4gICAgICBAdHJpZ2dlciAncHJlLXRyYW5zaXRpb246JytzdGF0ZUtleVxuXG4gICAgICBpZiBzdGF0ZU9wdGlvbnMudXJsXG4gICAgICAgICMgYXJncyBpcyBhbiBhcnJheSB3aGVuOlxuICAgICAgICAjICAgMSkgSXQgY29tZXMgZnJvbSBhIHJvdXRlIGNhbGxiYWNrXG4gICAgICAgICMgICAyKSBJcyBwYXNzZWQgYXMgYXJyYXkgaW4gYmItcm91dGUgZGlyZWN0aXZlXG4gICAgICAgICMgICAzKSBJcyBpbnRlcnBvbGF0ZWQgZnJvbSBhIGxpbmsgd2l0aCBhIHVybCBkZWZpbmVkXG4gICAgICAgIGlmIGFyZ3MgaW5zdGFuY2VvZiBBcnJheVxuXG4gICAgICAgICAgYXJnc09iamVjdCA9IF8ub2JqZWN0IHN0YXRlT3B0aW9ucy5fdXJsUGFyYW1zLCBhcmdzXG5cbiAgICAgICAgICAjIFBlcmZvcm0gdGhlIG9wcG9zaXRlIG9mIHJvdXRlcyBoYXNoIGFuZCBmaWxsIGluIHVybCBwYXJhbWV0ZXJzIHdpdGggZGF0YVxuICAgICAgICAgIHVybCA9IHN0YXRlT3B0aW9ucy5fdXJsQXNUZW1wbGF0ZSBhcmdzT2JqZWN0XG5cbiAgICAgICAgICB1bmxlc3MgaGlzdG9yeUhhc1VwZGF0ZWRcbiAgICAgICAgICAgIEByb3V0ZXIubmF2aWdhdGUgdXJsXG5cbiAgICAgICAgICBkYXRhID0gYXJnc1xuICAgICAgICAgIGRhdGEucHVzaCBudWxsICMgdGhpcyByZXByZXNlbnRzIHRoZSBxdWVyeSBwYXJhbXMgdmFsdWUsIHdoaWNoIHJvdXRlcnMgYWx3YXlzIGFwcGVuZCBub3dcblxuICAgICAgICBlbHNlIGlmIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgIyBhcmdzIGlzIGFsbG93ZWQgdG8gYmUgYW4gb2JqZWN0IGZvciBiYi1zdGF0ZSBkaXJlY3RpdmVzXG5cbiAgICAgICAgICAjIFBlcmZvcm0gdGhlIG9wcG9zaXRlIG9mIHJvdXRlcyBoYXNoIGFuZCBmaWxsIGluIHVybCBwYXJhbWV0ZXJzIHdpdGggZGF0YVxuICAgICAgICAgIHVybCA9IHN0YXRlT3B0aW9ucy5fdXJsQXNUZW1wbGF0ZSBhcmdzXG5cbiAgICAgICAgICB1bmxlc3MgaGlzdG9yeUhhc1VwZGF0ZWRcbiAgICAgICAgICAgIEByb3V0ZXIubmF2aWdhdGUgdXJsXG5cbiAgICAgICAgICBkYXRhID0gQHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMgc3RhdGVPcHRpb25zLl91cmxBc1JlZ2V4LCB1cmwgIyBVc2Ugcm91dGVyIHRvIGd1YXJhbnRlZSBwYXJhbSBvcmRlclxuICAgICAgICBlbHNlXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yICdBcmdzIGFyZSBvbmx5IHN1cHBvcnRlZCBhcyBhbiBvYmplY3Qgb3IgYXJyYXkgaWYgc3RhdGUudXJsIGlzIGRlZmluZWQnXG5cbiAgICAgICAgb3B0aW9ucyA9XG4gICAgICAgICAgdXJsOiB1cmxcbiAgICAgICAgZGF0YS5wdXNoIG9wdGlvbnNcbiAgICAgIGVsc2VcbiAgICAgICAgIyBub24tdXJsIGRyaXZlbiBzdGF0ZXMgbWVhbiB3ZSBwYXNzIGRhdGEgcmlnaHQgdGhyb3VnaFxuICAgICAgICBkYXRhID0gYXJnc1xuXG4gICAgICBAW3N0YXRlT3B0aW9ucy50cmFuc2l0aW9uTWV0aG9kXS5hcHBseSB0aGlzLCBkYXRhXG5cbiAgICAgIEB0cmlnZ2VyICdwb3N0LXRyYW5zaXRpb246JytzdGF0ZUtleVxuICAgICAgQHRyaWdnZXIgJ3Bvc3QtdHJhbnNpdGlvbidcbiAgICAgIHJldHVyblxuXG4gICAgX3BhcnNlRXZlbnRzOiAtPlxuICAgICAgXy5lYWNoIF8ua2V5cyhAZXZlbnRzKSwgKGV2ZW50TmFtZSkgPT5cbiAgICAgICAgQG9uIGV2ZW50TmFtZSwgPT5cbiAgICAgICAgICBldmVudEZ1bmN0aW9uID0gQGV2ZW50c1tldmVudE5hbWVdXG4gICAgICAgICAgQFtldmVudEZ1bmN0aW9uXSgpXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIHJldHVyblxuICAgICAgcmV0dXJuXG5cbiAgQmFja2JvbmUuTWFuYWdlciA9IE1hbmFnZXJcbiAgQmFja2JvbmUuTWFuYWdlci5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQgIyB0b2RvIGM6IEJlIHNtYXJ0ZXIgYWJvdXQgdGhpcyBsYXRlclxuXG4gIF93YXRjaEZvclN0YXRlQ2hhbmdlID0gLT5cbiAgICAkKCdib2R5Jykub24gJ2NsaWNrJywgKGV2ZW50KSAtPlxuICAgICAgdW5sZXNzIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpXG4gICAgICAgIGlmICQoZXZlbnQudGFyZ2V0KS5hdHRyKCd4LWJiLXN0YXRlJylcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgICAgc3RhdGVJbmZvID0gJChldmVudC50YXJnZXQpLmF0dHIoJ3gtYmItc3RhdGUnKS5zcGxpdCgnKCcsIDIpXG4gICAgICAgICAgc3RhdGUgPSBzdGF0ZUluZm9bMF1cbiAgICAgICAgICBhcmdzID0gc3RhdGVJbmZvWzFdLnNsaWNlIDAsIHN0YXRlSW5mb1sxXS5pbmRleE9mKCcpJylcbiAgICAgICAgICBtYW5hZ2VyUXVldWUudHJpZ2dlciBzdGF0ZSwgSlNPTi5wYXJzZShhcmdzKVxuICAgICAgcmV0dXJuXG5cbiAgIyBCaW5kIHdhdGNoZXIgdG8gb25SZWFkeVxuICAkIF93YXRjaEZvclN0YXRlQ2hhbmdlXG4gIHJldHVyblxuKShCYWNrYm9uZSwgXywgJCwgd2luZG93KVxuIl19