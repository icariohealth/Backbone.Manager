(function(Backbone, _, $, window) {
  var Manager, cachedParamMatcher, managerQueue, onloadUrl, _watchForStateChange;
  managerQueue = _.extend({}, Backbone.Events);
  onloadUrl = window.location.href;
  cachedParamMatcher = /\:([^:)/]+)/g;
  Manager = (function() {
    Manager.prototype.states = {};

    Manager.prototype.events = {};

    function Manager(router, options) {
      this.router = router;
      _.extend(this, Backbone.Events);
      this._parseStates();
      this._parseEvents();
      this.initialize(options);
      return;
    }

    Manager.prototype.initialize = function() {};

    Manager.prototype._parseStates = function() {
      _.each(_.keys(this.states), (function(_this) {
        return function(stateKey) {
          var stateOptions;
          stateOptions = _this.states[stateKey];
          if (!stateOptions.transitionMethod) {
            throw new Error(stateKey + ' needs transitionMethod definitions');
          }
          if (stateOptions.url) {
            stateOptions._urlParams = cachedParamMatcher.exec(stateOptions.url).slice(1);
            stateOptions._urlAsTemplate = _.template(stateOptions.url, null, {
              interpolate: cachedParamMatcher
            });
            stateOptions._urlAsRegex = stateOptions.url;
            if (!_.isRegExp(stateOptions._urlAsRegex)) {
              stateOptions._urlAsRegex = _this.router._routeToRegExp(stateOptions._urlAsRegex);
            }
            _this.router.route(stateOptions._urlAsRegex, stateKey, function() {
              var historyHasUpdated;
              if (onloadUrl && (window != null ? window.location.href : void 0) === onloadUrl) {
                _this._handleLoadCallback(stateKey, stateOptions, arguments);
              } else {
                _this._handleTransitionCallback(stateKey, stateOptions, arguments, historyHasUpdated = true);
              }
              onloadUrl = null;
            });
          }
          return _this.listenTo(managerQueue, stateKey, function(args) {
            _this._handleTransitionCallback(stateKey, stateOptions, args);
          });
        };
      })(this));
    };

    Manager.prototype._handleLoadCallback = function(stateKey, stateOptions, args) {
      if (!stateOptions.loadMethod) {
        throw new Error(stateKey + ' is being triggered for load, but no loadMethod has been defined');
      }
      this.trigger('pre-load');
      this.trigger('pre-load:' + stateKey, args);
      this[stateOptions.loadMethod].apply(this, args);
      this.trigger('post-load:' + stateKey, args);
      this.trigger('post-load');
    };

    Manager.prototype._handleTransitionCallback = function(stateKey, stateOptions, args, historyHasUpdated) {
      var argsObject, data, options, url;
      if (historyHasUpdated == null) {
        historyHasUpdated = false;
      }
      this.trigger('pre-transition');
      this.trigger('pre-transition:' + stateKey);
      if (stateOptions.url) {
        if (args instanceof Array) {
          argsObject = _.object(stateOptions._urlParams, args);
          url = stateOptions._urlAsTemplate(argsObject);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = args;
          data.push(null);
        } else if (args instanceof Object) {
          url = stateOptions._urlAsTemplate(args);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = this.router._extractParameters(stateOptions._urlAsRegex, url);
        } else {
          throw new Error('Args are only supported as an object or array if state.url is defined');
        }
        options = {
          url: url
        };
        data.push(options);
      } else {
        data = args;
      }
      this[stateOptions.transitionMethod].apply(this, data);
      this.trigger('post-transition:' + stateKey);
      this.trigger('post-transition');
    };

    Manager.prototype._parseEvents = function() {
      _.each(_.keys(this.events), (function(_this) {
        return function(eventName) {
          _this.on(eventName, function() {
            var eventFunction;
            eventFunction = _this.events[eventName];
            _this[eventFunction]();
          });
        };
      })(this));
    };

    return Manager;

  })();
  Backbone.Manager = Manager;
  Backbone.Manager.extend = Backbone.Model.extend;
  _watchForStateChange = function() {
    return $('body').on('click', function(event) {
      var args, state, stateInfo;
      if (!event.isDefaultPrevented()) {
        if ($(event.target).attr('x-bb-state')) {
          event.preventDefault();
          stateInfo = $(event.target).attr('x-bb-state').split('(', 2);
          state = stateInfo[0];
          args = stateInfo[1].slice(0, stateInfo[1].indexOf(')'));
          managerQueue.trigger(state, JSON.parse(args));
        }
      }
    });
  };
  $(_watchForStateChange);
})(Backbone, _, $, window);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tib25lLm1hbmFnZXIuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLENBQUMsU0FBQyxRQUFELEVBQVcsQ0FBWCxFQUFjLENBQWQsRUFBaUIsTUFBakIsR0FBQTtBQUNDLE1BQUEsMEVBQUE7QUFBQSxFQUFBLFlBQUEsR0FBZSxDQUFDLENBQUMsTUFBRixDQUFTLEVBQVQsRUFBYSxRQUFRLENBQUMsTUFBdEIsQ0FBZixDQUFBO0FBQUEsRUFDQSxTQUFBLEdBQVksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUQ1QixDQUFBO0FBQUEsRUFHQSxrQkFBQSxHQUFxQixjQUhyQixDQUFBO0FBQUEsRUF3Qk07QUFXSixzQkFBQSxNQUFBLEdBQVEsRUFBUixDQUFBOztBQUFBLHNCQU1BLE1BQUEsR0FBUSxFQU5SLENBQUE7O0FBUWEsSUFBQSxpQkFBQyxNQUFELEVBQVMsT0FBVCxHQUFBO0FBQ1gsTUFBQSxJQUFDLENBQUEsTUFBRCxHQUFVLE1BQVYsQ0FBQTtBQUFBLE1BQ0EsQ0FBQyxDQUFDLE1BQUYsQ0FBUyxJQUFULEVBQVksUUFBUSxDQUFDLE1BQXJCLENBREEsQ0FBQTtBQUFBLE1BRUEsSUFBQyxDQUFBLFlBQUQsQ0FBQSxDQUZBLENBQUE7QUFBQSxNQUdBLElBQUMsQ0FBQSxZQUFELENBQUEsQ0FIQSxDQUFBO0FBQUEsTUFJQSxJQUFDLENBQUEsVUFBRCxDQUFZLE9BQVosQ0FKQSxDQUFBO0FBS0EsWUFBQSxDQU5XO0lBQUEsQ0FSYjs7QUFBQSxzQkFpQkEsVUFBQSxHQUFZLFNBQUEsR0FBQSxDQWpCWixDQUFBOztBQUFBLHNCQW1CQSxZQUFBLEdBQWMsU0FBQSxHQUFBO0FBQ1osTUFBQSxDQUFDLENBQUMsSUFBRixDQUFPLENBQUMsQ0FBQyxJQUFGLENBQU8sSUFBQyxDQUFBLE1BQVIsQ0FBUCxFQUF3QixDQUFBLFNBQUEsS0FBQSxHQUFBO2VBQUEsU0FBQyxRQUFELEdBQUE7QUFDdEIsY0FBQSxZQUFBO0FBQUEsVUFBQSxZQUFBLEdB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QUFDLEVBQVYsQ0FBYSxPQUFiLEVBQXNCLFNBQUMsS0FBRCxHQUFBO0FBQ3BCLFVBQUEsc0JBQUE7QUFBQSxNQUFBLElBQUEsQ0FBQSxLQUFZLENBQUMsa0JBQU4sQ0FBQSxDQUFQO0FBQ0UsUUFBQSxJQUFHLENBQUEsQ0FBRSxLQUFLLENBQUMsTUFBUixDQUFlLENBQUMsSUFBaEIsQ0FBcUIsWUFBckIsQ0FBSDtBQUNFLFVBQUEsS0FBSyxDQUFDLGNBQU4sQ0FBQSxDQUFBLENBQUE7QUFBQSxVQUNBLFNBQUEsR0FBWSxDQUFBLENBQUUsS0FBSyxDQUFDLE1BQVIsQ0FBZSxDQUFDLElBQWhCLENBQXFCLFlBQXJCLENBQWtDLENBQUMsS0FBbkMsQ0FBeUMsR0FBekMsRUFBOEMsQ0FBOUMsQ0FEWixDQUFBO0FBQUEsVUFFQSxLQUFBLEdBQVEsU0FBVSxDQUFBLENBQUEsQ0FGbEIsQ0FBQTtBQUFBLFVBR0EsSUFBQSxHQUFPLFNBQVUsQ0FBQSxDQUFBLENBQUUsQ0FBQyxLQUFiLENBQW1CLENBQW5CLEVBQXNCLFNBQVUsQ0FBQSxDQUFBLENBQUUsQ0FBQyxPQUFiLENBQXFCLEdBQXJCLENBQXRCLENBSFAsQ0FBQTtBQUFBLFVBSUEsWUFBWSxDQUFDLE9BQWIsQ0FBcUIsS0FBckIsRUFBNEIsSUFBSSxDQUFDLEtBQUwsQ0FBVyxJQUFYLENBQTVCLENBSkEsQ0FERjtTQURGO09BRG9CO0lBQUEsQ0FBdEIsRUFEcUI7RUFBQSxDQXBLdkIsQ0FBQTtBQUFBLEVBZ0xBLENBQUEsQ0FBRSxvQkFBRixDQWhMQSxDQUREO0FBQUEsQ0FBRCxDQUFBLENBbUxFLFFBbkxGLEVBbUxZLENBbkxaLEVBbUxlLENBbkxmLEVBbUxrQixNQW5MbEIsQ0FBQSxDQUFBIiwiZmlsZSI6ImJhY2tib25lLm1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyIoKEJhY2tib25lLCBfLCAkLCB3aW5kb3cpIC0+XG4gIG1hbmFnZXJRdWV1ZSA9IF8uZXh0ZW5kIHt9LCBCYWNrYm9uZS5FdmVudHNcbiAgb25sb2FkVXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWZcblxuICBjYWNoZWRQYXJhbU1hdGNoZXIgPSAvXFw6KFteOikvXSspL2dcblxuICAjIE1hbmFnZXIocm91dGVyKSAtIHJvdXRlciB3aWxsIGJlIHdoZXJlIHRoZSBoaXN0b3J5IG5hdmlnYXRpb24gaXMgcHVzaGVkIHRocm91Z2hcbiAgI1xuICAjICBXaGVuIHN0YXRlIGNoYW5nZSBpcyB0cmlnZ2VyZWQ6XG4gICMgICAgLSByb3V0ZXIgbmF2aWdhdGUgb2NjdXJzIGlmIHRoZSBzdGF0ZSBoYXMgYW4gdXJsXG4gICMgICAgLSBhcHByb3ByaWF0ZSBwcmUgZXZlbnRzIChsb2FkL3RyYW5zaXRpb24pIGFyZSB0cmlnZ2VyZWQsIGJvdGggZ2VuZXJpYyBhbmQgc3RhdGUgc3BlY2lmaWNcbiAgIyAgICAtIG1ha2UgY2FsbCB0byBtZXRob2RcbiAgIyAgICAtIGFwcHJvcHJpYXRlIHBvc3QgZXZlbnRzIChsb2FkL3RyYW5zaXRpb24pIGFyZSB0cmlnZ2VyZWQsIGJvdGggZ2VuZXJpYyBhbmQgc3RhdGUgc3BlY2lmaWNcbiAgI1xuICAjICBUcmlnZ2VyZWQgRXZlbnRzOlxuICAjICAgIHByZS1sb2FkICAgICAgICAgICAgICAgICAtIGluZGljYXRlcyBpbmNvbWluZyBwYWdlIGxvYWQgY2FsbCBmb3IgYWxsIHN0YXRlc1xuICAjICAgIHByZS1sb2FkOltzdGF0ZV0gKGFyZ3MpICAtIGluZGljYXRlcyBpbmNvbWluZyBwYWdlIGxvYWQgY2FsbCBmb3IgdGhlIHN0YXRlXG4gICMgICAgcG9zdC1sb2FkICAgICAgICAgICAgICAgIC0gaW5kaWNhdGVzIGluY29taW5nIHBhZ2UgbG9hZCBjYWxsIGNvbXBsZXRlZCBmb3IgYWxsIHN0YXRlc1xuICAjICAgIHBvc3QtbG9hZDpbc3RhdGVdIChhcmdzKSAtIGluZGljYXRlcyBpbmNvbWluZyBwYWdlIGxvYWQgY2FsbCBjb21wbGV0ZWQgZm9yIHRoZSBzdGF0ZVxuICAjXG4gICMgICAgcHJlLXRyYW5zaXRpb24gICAgICAgICAgLSBpbmRpY2F0ZXMgaW5jb21pbmcgdHJhbnNpdGlvbiBjYWxsIGZvciBhbGwgc3RhdGVzXG4gICMgICAgcHJlLXRyYW5zaXRpb246W3N0YXRlXSAgLSBpbmRpY2F0ZXMgaW5jb21pbmcgdHJhbnNpdGlvbiBjYWxsIGZvciB0aGUgc3RhdGVcbiAgIyAgICBwb3N0LXRyYW5zaXRpb24gICAgICAgICAtIGluZGljYXRlcyB0cmFuc2l0aW9uIGNhbGwgY29tcGxldGVkIGZvciBhbGwgc3RhdGVzXG4gICMgICAgcG9zdC10cmFuc2l0aW9uOltzdGF0ZV0gLSBpbmRpY2F0ZXMgdHJhbnNpdGlvbiBjYWxsIGNvbXBsZXRlZCBmb3IgdGhlIHN0YXRlXG4gICNcbiAgY2xhc3MgTWFuYWdlclxuICAgICMgc3RhdGUgc3RydWN0dXJlOlxuICAgICMge1xuICAgICMgICAndXNlcnMnOiB7XG4gICAgIyAgICAgdXJsOiAndXNlcnMvOmlkJyAob3B0aW9uYWwpXG4gICAgIyAgICAgbG9hZE1ldGhvZDogJ2dvVXNlcicgKG9wdGlvbmFsKSAjIGZ1bmN0aW9ucyBsaWtlIHJvdXRlciwgd2lsbCBiZSBjYWxsZWQgd2l0aCBnb1VzZXIoe2lkOiAxfSlcbiAgICAjICAgICB0cmFuc2l0aW9uTWV0aG9kOiAnbW92ZVRvVXNlcidcbiAgICAjICAgfVxuICAgICMgfVxuICAgICNcbiAgICAjXG4gICAgc3RhdGVzOiB7fVxuXG4gICAgIyBldmVudCBzdHJ1Y3R1cmUgYmFzZWQgb24gZGVmaW5lZCBNYW5hZ2VyIHRyaWdnZXJlZCBldmVudHNcbiAgICAjIHtcbiAgICAjICAgJ3ByZS10cmFuc2l0aW9uOnVzZXJzJzogJ3Nob3dBbGVydCdcbiAgICAjIH1cbiAgICBldmVudHM6IHt9XG5cbiAgICBjb25zdHJ1Y3RvcjogKHJvdXRlciwgb3B0aW9ucykgLT5cbiAgICAgIEByb3V0ZXIgPSByb3V0ZXJcbiAgICAgIF8uZXh0ZW5kIEAsIEJhY2tib25lLkV2ZW50c1xuICAgICAgQF9wYXJzZVN0YXRlcygpXG4gICAgICBAX3BhcnNlRXZlbnRzKClcbiAgICAgIEBpbml0aWFsaXplIG9wdGlvbnNcbiAgICAgIHJldHVyblxuXG4gICAgIyBFbXB0eSBieSBkZWZhdWx0LiBPdmVycmlkZSB3aXRoIGN1c3RvbSBsb2dpY1xuICAgIGluaXRpYWxpemU6IC0+XG5cbiAgICBfcGFyc2VTdGF0ZXM6IC0+XG4gICAgICBfLmVhY2ggXy5rZXlzKEBzdGF0ZXMpLCAoc3RhdGVLZXkpID0+XG4gICAgICAgIHN0YXRlT3B0aW9ucyA9IEBzdGF0ZXNbc3RhdGVLZXldXG5cbiAgICAgICAgdW5sZXNzIHN0YXRlT3B0aW9ucy50cmFuc2l0aW9uTWV0aG9kXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yIHN0YXRlS2V5KycgbmVlZHMgdHJhbnNpdGlvbk1ldGhvZCBkZWZpbml0aW9ucydcblxuICAgICAgICBpZiBzdGF0ZU9wdGlvbnMudXJsXG4gICAgICAgICAgc3RhdGVPcHRpb25zLl91cmxQYXJhbXMgPSBjYWNoZWRQYXJhbU1hdGNoZXIuZXhlYyhzdGF0ZU9wdGlvbnMudXJsKS5zbGljZSgxKVxuICAgICAgICAgIHN0YXRlT3B0aW9ucy5fdXJsQXNUZW1wbGF0ZSA9IF8udGVtcGxhdGUgc3RhdGVPcHRpb25zLnVybCwgbnVsbCwge2ludGVycG9sYXRlOiBjYWNoZWRQYXJhbU1hdGNoZXJ9XG4gICAgICAgICAgc3RhdGVPcHRpb25zLl91cmxBc1JlZ2V4ID0gc3RhdGVPcHRpb25zLnVybFxuXG4gICAgICAgICAgdW5sZXNzIF8uaXNSZWdFeHAoc3RhdGVPcHRpb25zLl91cmxBc1JlZ2V4KVxuICAgICAgICAgICAgc3RhdGVPcHRpb25zLl91cmxBc1JlZ2V4ID0gQHJvdXRlci5fcm91dGVUb1JlZ0V4cCBzdGF0ZU9wdGlvbnMuX3VybEFzUmVnZXhcblxuICAgICAgICAgICMgUmVnaXN0ZXIgdGhlIHVybHMgaW50byB0aGUgcm91dGVyXG4gICAgICAgICAgQHJvdXRlci5yb3V0ZSBzdGF0ZU9wdGlvbnMuX3VybEFzUmVnZXgsIHN0YXRlS2V5LCA9PlxuXG4gICAgICAgICAgICAjIE9ubHkgcnVuIGxvYWRDYWxsYmFjayBpZiB0aGlzIGlzIHRydWx5IHRoZSB2ZXJ5IGZpcnN0IGNhbGxiYWNrIGZyb20gdGhlIHBhZ2Vsb2FkIHBvcHN0YXRlXG4gICAgICAgICAgICAjIEluIG90aGVyIGNhc2VzLCBCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IHBvdGVudGlhbGx5IGNoYW5nZWQgdGhlIHVybCBmb3Igcm91dGVyIG5hdixcbiAgICAgICAgICAgICMgc28gd2UgY2hlY2sgYWdhaW5zdCBpdFxuICAgICAgICAgICAgaWYgb25sb2FkVXJsIGFuZCB3aW5kb3c/LmxvY2F0aW9uLmhyZWYgaXMgb25sb2FkVXJsICMgdG9kbyBhOiB2ZXJpZnkgdGhpcyB3b3JrcyBjcm9zcyBicm93c2VyICYgdy8gaGFzaFxuICAgICAgICAgICAgICBAX2hhbmRsZUxvYWRDYWxsYmFjayBzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmd1bWVudHNcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgQF9oYW5kbGVUcmFuc2l0aW9uQ2FsbGJhY2sgc3RhdGVLZXksIHN0YXRlT3B0aW9ucywgYXJndW1lbnRzLCBoaXN0b3J5SGFzVXBkYXRlZCA9IHRydWVcblxuICAgICAgICAgICAgb25sb2FkVXJsID0gbnVsbFxuICAgICAgICAgICAgcmV0dXJuXG5cbiAgICAgICAgIyBTdGFydCBsaXN0ZW5pbmcgZm9yIG91ciBzdGF0ZSB0cmFuc2l0aW9uIGNhbGxzXG4gICAgICAgIEBsaXN0ZW5UbyBtYW5hZ2VyUXVldWUsIHN0YXRlS2V5LCAoYXJncykgPT5cbiAgICAgICAgICBAX2hhbmRsZVRyYW5zaXRpb25DYWxsYmFjayBzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzXG4gICAgICAgICAgcmV0dXJuXG4gICAgICByZXR1cm5cblxuICAgIF9oYW5kbGVMb2FkQ2FsbGJhY2s6IChzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzKSAtPlxuICAgICAgdW5sZXNzIHN0YXRlT3B0aW9ucy5sb2FkTWV0aG9kXG4gICAgICAgIHRocm93IG5ldyBFcnJvciBzdGF0ZUtleSsnIGlzIGJlaW5nIHRyaWdnZXJlZCBmb3IgbG9hZCwgYnV0IG5vIGxvYWRNZXRob2QgaGFzIGJlZW4gZGVmaW5lZCdcblxuICAgICAgQHRyaWdnZXIgJ3ByZS1sb2FkJ1xuICAgICAgQHRyaWdnZXIgJ3ByZS1sb2FkOicrc3RhdGVLZXksIGFyZ3NcbiAgICAgIEBbc3RhdGVPcHRpb25zLmxvYWRNZXRob2RdLmFwcGx5IHRoaXMsIGFyZ3NcbiAgICAgIEB0cmlnZ2VyICdwb3N0LWxvYWQ6JytzdGF0ZUtleSwgYXJnc1xuICAgICAgQHRyaWdnZXIgJ3Bvc3QtbG9hZCdcbiAgICAgIHJldHVyblxuXG4gICAgIyBSZWFjaGVkIGluIHR3byB3YXlzOlxuICAgICMgIDEpIENhbGxiYWNrIGZyb20gcm91dGVyIHJvdXRlIGhhbmRsZVxuICAgICMgICAgYSkgYXJncyBpcyBhbiBhcnJheSBmcm9tIHRoZSByb3V0ZSBjYWxsYmFja1xuICAgICMgIDIpIGJiLXN0YXRlIGNoYW5nZSBjYWxsYmFja1xuICAgICMgICAgYSkgYXJncyBpcyB3aGF0IHRoZSB1c2VyIGhhcyBwcm92aWRlZCBkZWNsYXJhdGl2ZWx5LCBvciBpdCdzIHBhcnNlZCBmcm9tIHRoZSBsaW5rIHVybFxuICAgIF9oYW5kbGVUcmFuc2l0aW9uQ2FsbGJhY2s6IChzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzLCBoaXN0b3J5SGFzVXBkYXRlZCA9IGZhbHNlKSAtPlxuICAgICAgQHRyaWdnZXIgJ3ByZS10cmFuc2l0aW9uJ1xuICAgICAgQHRyaWdnZXIgJ3ByZS10cmFuc2l0aW9uOicrc3RhdGVLZXlcblxuICAgICAgaWYgc3RhdGVPcHRpb25zLnVybFxuICAgICAgICAjIGFyZ3MgaXMgYW4gYXJyYXkgd2hlbjpcbiAgICAgICAgIyAgIDEpIEl0IGNvbWVzIGZyb20gYSByb3V0ZSBjYWxsYmFja1xuICAgICAgICAjICAgMikgSXMgcGFzc2VkIGFzIGFycmF5IGluIGJiLXJvdXRlIGRpcmVjdGl2ZVxuICAgICAgICAjICAgMykgSXMgaW50ZXJwb2xhdGVkIGZyb20gYSBsaW5rIHdpdGggYSB1cmwgZGVmaW5lZFxuICAgICAgICBpZiBhcmdzIGluc3RhbmNlb2YgQXJyYXlcblxuICAgICAgICAgIGFyZ3NPYmplY3QgPSBfLm9iamVjdCBzdGF0ZU9wdGlvbnMuX3VybFBhcmFtcywgYXJnc1xuXG4gICAgICAgICAgIyBQZXJmb3JtIHRoZSBvcHBvc2l0ZSBvZiByb3V0ZXMgaGFzaCBhbmQgZmlsbCBpbiB1cmwgcGFyYW1ldGVycyB3aXRoIGRhdGFcbiAgICAgICAgICB1cmwgPSBzdGF0ZU9wdGlvbnMuX3VybEFzVGVtcGxhdGUgYXJnc09iamVjdFxuXG4gICAgICAgICAgdW5sZXNzIGhpc3RvcnlIYXNVcGRhdGVkXG4gICAgICAgICAgICBAcm91dGVyLm5hdmlnYXRlIHVybFxuXG4gICAgICAgICAgZGF0YSA9IGFyZ3NcbiAgICAgICAgICBkYXRhLnB1c2ggbnVsbCAjIHRoaXMgcmVwcmVzZW50cyB0aGUgcXVlcnkgcGFyYW1zIHZhbHVlLCB3aGljaCByb3V0ZXJzIGFsd2F5cyBhcHBlbmQgbm93XG5cbiAgICAgICAgZWxzZSBpZiBhcmdzIGluc3RhbmNlb2YgT2JqZWN0ICMgYXJncyBpcyBhbGxvd2VkIHRvIGJlIGFuIG9iamVjdCBmb3IgYmItc3RhdGUgZGlyZWN0aXZlc1xuXG4gICAgICAgICAgIyBQZXJmb3JtIHRoZSBvcHBvc2l0ZSBvZiByb3V0ZXMgaGFzaCBhbmQgZmlsbCBpbiB1cmwgcGFyYW1ldGVycyB3aXRoIGRhdGFcbiAgICAgICAgICB1cmwgPSBzdGF0ZU9wdGlvbnMuX3VybEFzVGVtcGxhdGUgYXJnc1xuXG4gICAgICAgICAgdW5sZXNzIGhpc3RvcnlIYXNVcGRhdGVkXG4gICAgICAgICAgICBAcm91dGVyLm5hdmlnYXRlIHVybFxuXG4gICAgICAgICAgZGF0YSA9IEByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzIHN0YXRlT3B0aW9ucy5fdXJsQXNSZWdleCwgdXJsICMgVXNlIHJvdXRlciB0byBndWFyYW50ZWUgcGFyYW0gb3JkZXJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHRocm93IG5ldyBFcnJvciAnQXJncyBhcmUgb25seSBzdXBwb3J0ZWQgYXMgYW4gb2JqZWN0IG9yIGFycmF5IGlmIHN0YXRlLnVybCBpcyBkZWZpbmVkJ1xuXG4gICAgICAgIG9wdGlvbnMgPVxuICAgICAgICAgIHVybDogdXJsXG4gICAgICAgIGRhdGEucHVzaCBvcHRpb25zXG4gICAgICBlbHNlXG4gICAgICAgICMgbm9uLXVybCBkcml2ZW4gc3RhdGVzIG1lYW4gd2UgcGFzcyBkYXRhIHJpZ2h0IHRocm91Z2hcbiAgICAgICAgZGF0YSA9IGFyZ3NcblxuICAgICAgQFtzdGF0ZU9wdGlvbnMudHJhbnNpdGlvbk1ldGhvZF0uYXBwbHkgdGhpcywgZGF0YVxuXG4gICAgICBAdHJpZ2dlciAncG9zdC10cmFuc2l0aW9uOicrc3RhdGVLZXlcbiAgICAgIEB0cmlnZ2VyICdwb3N0LXRyYW5zaXRpb24nXG4gICAgICByZXR1cm5cblxuICAgIF9wYXJzZUV2ZW50czogLT5cbiAgICAgIF8uZWFjaCBfLmtleXMoQGV2ZW50cyksIChldmVudE5hbWUpID0+XG4gICAgICAgIEBvbiBldmVudE5hbWUsID0+XG4gICAgICAgICAgZXZlbnRGdW5jdGlvbiA9IEBldmVudHNbZXZlbnROYW1lXVxuICAgICAgICAgIEBbZXZlbnRGdW5jdGlvbl0oKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICByZXR1cm5cbiAgICAgIHJldHVyblxuXG4gIEJhY2tib25lLk1hbmFnZXIgPSBNYW5hZ2VyXG4gIEJhY2tib25lLk1hbmFnZXIuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kICMgdG9kbyBjOiBCZSBzbWFydGVyIGFib3V0IHRoaXMgbGF0ZXJcblxuICBfd2F0Y2hGb3JTdGF0ZUNoYW5nZSA9IC0+XG4gICAgJCgnYm9keScpLm9uICdjbGljaycsIChldmVudCkgLT5cbiAgICAgIHVubGVzcyBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKVxuICAgICAgICBpZiAkKGV2ZW50LnRhcmdldCkuYXR0cigneC1iYi1zdGF0ZScpXG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuICAgICAgICAgIHN0YXRlSW5mbyA9ICQoZXZlbnQudGFyZ2V0KS5hdHRyKCd4LWJiLXN0YXRlJykuc3BsaXQoJygnLCAyKVxuICAgICAgICAgIHN0YXRlID0gc3RhdGVJbmZvWzBdXG4gICAgICAgICAgYXJncyA9IHN0YXRlSW5mb1sxXS5zbGljZSAwLCBzdGF0ZUluZm9bMV0uaW5kZXhPZignKScpXG4gICAgICAgICAgbWFuYWdlclF1ZXVlLnRyaWdnZXIgc3RhdGUsIEpTT04ucGFyc2UoYXJncylcbiAgICAgIHJldHVyblxuXG4gICMgQmluZCB3YXRjaGVyIHRvIG9uUmVhZHlcbiAgJCBfd2F0Y2hGb3JTdGF0ZUNoYW5nZVxuICByZXR1cm5cbikoQmFja2JvbmUsIF8sICQsIHdpbmRvdylcbiJdfQ==