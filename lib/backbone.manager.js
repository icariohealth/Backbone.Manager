(function(Backbone, _, $, window) {
  var Manager, cachedParamMatcher, managerQueue, onloadUrl, _watchForStateChange;
  managerQueue = _.extend({}, Backbone.Events);
  onloadUrl = window.location.href;
  cachedParamMatcher = /\:([^:)/]+)/g;
  Manager = (function() {
    Manager.prototype.states = {};

    Manager.prototype.events = {};

    function Manager(router, options) {
      this.router = router;
      _.extend(this, Backbone.Events);
      this._parseStates();
      this._parseEvents();
      this.initialize(options);
      return;
    }

    Manager.prototype.initialize = function() {};

    Manager.prototype._parseStates = function() {
      _.each(_.keys(this.states), (function(_this) {
        return function(stateKey) {
          var matches, stateOptions;
          stateOptions = _this.states[stateKey];
          if (!stateOptions.transitionMethod) {
            throw new Error(stateKey + ' needs transitionMethod definitions');
          }
          if (stateOptions.url) {
            if (_.isRegExp(stateOptions.url)) {
              throw new Error(stateKey + ' is not allowed to have a RegExp url');
            }
            stateOptions._urlParams = (function() {
              var _results;
              _results = [];
              while (matches = cachedParamMatcher.exec(stateOptions.url)) {
                _results.push(matches[1]);
              }
              return _results;
            })();
            stateOptions._urlAsTemplate = _.template(stateOptions.url, null, {
              interpolate: cachedParamMatcher
            });
            stateOptions._urlAsRegex = _this.router._routeToRegExp(stateOptions.url);
            _this.router.route(stateOptions._urlAsRegex, stateKey, function() {
              _this._routeCallbackChooser(stateKey, stateOptions, arguments);
            });
          }
          return _this.listenTo(managerQueue, stateKey, function(args) {
            _this._handleTransitionCallback(stateKey, stateOptions, args);
          });
        };
      })(this));
    };

    Manager.prototype._routeCallbackChooser = function(stateKey, stateOptions, clearOnloadUrl) {
      var historyHasUpdated;
      if (clearOnloadUrl == null) {
        clearOnloadUrl = true;
      }
      if (onloadUrl && this._getWindowHref() === onloadUrl) {
        this._handleLoadCallback(stateKey, stateOptions, arguments);
      } else {
        this._handleTransitionCallback(stateKey, stateOptions, arguments, historyHasUpdated = true);
      }
      if (clearOnloadUrl) {
        onloadUrl = null;
      }
    };

    Manager.prototype._handleLoadCallback = function(stateKey, stateOptions, args) {
      if (!stateOptions.loadMethod) {
        throw new Error(stateKey + ' is being triggered for load, but no loadMethod has been defined');
      }
      this.trigger('pre-load');
      this.trigger('pre-load:' + stateKey, args);
      this[stateOptions.loadMethod].apply(this, args);
      this.trigger('post-load:' + stateKey, args);
      this.trigger('post-load');
    };

    Manager.prototype._handleTransitionCallback = function(stateKey, stateOptions, args, historyHasUpdated) {
      var argsObject, data, options, url;
      if (historyHasUpdated == null) {
        historyHasUpdated = false;
      }
      this.trigger('pre-transition');
      this.trigger('pre-transition:' + stateKey);
      if (stateOptions.url) {
        if (args instanceof Array) {
          argsObject = _.object(stateOptions._urlParams, args);
          url = stateOptions._urlAsTemplate(argsObject);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = _.map(args, String);
          data.push(null);
        } else if (args instanceof Object) {
          url = stateOptions._urlAsTemplate(args);
          if (!historyHasUpdated) {
            this.router.navigate(url);
          }
          data = this.router._extractParameters(stateOptions._urlAsRegex, url);
        } else {
          throw new Error('Args are only supported as an object or array if state.url is defined');
        }
        options = {
          url: url
        };
        data.push(options);
      } else {
        data = args;
      }
      this[stateOptions.transitionMethod].apply(this, data);
      this.trigger('post-transition:' + stateKey);
      this.trigger('post-transition');
    };

    Manager.prototype._parseEvents = function() {
      _.each(_.keys(this.events), (function(_this) {
        return function(eventName) {
          _this.on(eventName, _this[_this.events[eventName]]);
        };
      })(this));
    };

    Manager.prototype._getWindowHref = function() {
      return window != null ? window.location.href : void 0;
    };

    return Manager;

  })();
  Backbone.Manager = Manager;
  Backbone.Manager.extend = Backbone.Model.extend;
  _watchForStateChange = function() {
    return $('body').on('click', function(event) {
      var args, state, stateInfo;
      if (!event.isDefaultPrevented()) {
        if ($(event.target).attr('x-bb-state')) {
          event.preventDefault();
          stateInfo = $(event.target).attr('x-bb-state').split('(', 2);
          state = stateInfo[0];
          args = stateInfo[1].slice(0, stateInfo[1].indexOf(')'));
          managerQueue.trigger(state, JSON.parse(args));
        }
      }
    });
  };
  $(_watchForStateChange);
})(Backbone, _, $, window);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tib25lLm1hbmFnZXIuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLENBQUMsU0FBQyxRQUFELEVBQVcsQ0FBWCxFQUFjLENBQWQsRUFBaUIsTUFBakIsR0FBQTtBQUNDLE1BQUEsMEVBQUE7QUFBQSxFQUFBLFlBQUEsR0FBZSxDQUFDLENBQUMsTUFBRixDQUFTLEVBQVQsRUFBYSxRQUFRLENBQUMsTUFBdEIsQ0FBZixDQUFBO0FBQUEsRUFDQSxTQUFBLEdBQVksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUQ1QixDQUFBO0FBQUEsRUFHQSxrQkFBQSxHQUFxQixjQUhyQixDQUFBO0FBQUEsRUF3Qk07QUFXSixzQkFBQSxNQUFBLEdBQVEsRUFBUixDQUFBOztBQUFBLHNCQU1BLE1BQUEsR0FBUSxFQU5SLENBQUE7O0FBUWEsSUFBQSxpQkFBQyxNQUFELEVBQVMsT0FBVCxHQUFBO0FBQ1gsTUFBQSxJQUFDLENBQUEsTUFBRCxHQUFVLE1BQVYsQ0FBQTtBQUFBLE1BQ0EsQ0FBQyxDQUFDLE1BQUYsQ0FBUyxJQUFULEVBQVksUUFBUSxDQUFDLE1BQXJCLENBREEsQ0FBQTtBQUFBLE1BRUEsSUFBQyxDQUFBLFlBQUQsQ0FBQSxDQUZBLENBQUE7QUFBQSxNQUdBLElBQUMsQ0FBQSxZQUFELENBQUEsQ0FIQSxDQUFBO0FBQUEsTUFJQSxJQUFDLENBQUEsVUFBRCxDQUFZLE9BQVosQ0FKQSxDQUFBO0FBS0EsWUFBQSxDQU5XO0lBQUEsQ0FSYjs7QUFBQSxzQkFpQkEsVUFBQSxHQUFZLFNBQUEsR0FBQSxDQWpCWixDQUFBOztBQUFBLHNCQW1CQSxZQUFBLEdBQWMsU0FBQSxHQUFBO0FBQ1osTUFBQSxDQUFDLENBQUMsSUFBRixDQUFPLENBQUMsQ0FBQyxJQUFGLENBQU8sSUFBQyxDQUFBLE1BQVIsQ0FBUCxFQUF3QixDQUFBLFNBQUEsS0FBQSxHQUFBO2VBQUEsU0FBQyxRQUFELEdBQUE7QUFDdEIsY0FBQSxxQkFBQTtBQUFBLFVBQUEsWUFBQSxH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QixDQUFBO0FBQUEsRUFxTEEsQ0FBQSxDQUFFLG9CQUFGLENBckxBLENBREQ7QUFBQSxDQUFELENBQUEsQ0F3TEUsUUF4TEYsRUF3TFksQ0F4TFosRUF3TGUsQ0F4TGYsRUF3TGtCLE1BeExsQixDQUFBLENBQUEiLCJmaWxlIjoiYmFja2JvbmUubWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIigoQmFja2JvbmUsIF8sICQsIHdpbmRvdykgLT5cbiAgbWFuYWdlclF1ZXVlID0gXy5leHRlbmQge30sIEJhY2tib25lLkV2ZW50c1xuICBvbmxvYWRVcmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZlxuXG4gIGNhY2hlZFBhcmFtTWF0Y2hlciA9IC9cXDooW146KS9dKykvZ1xuXG4gICMgTWFuYWdlcihyb3V0ZXIpIC0gcm91dGVyIHdpbGwgYmUgd2hlcmUgdGhlIGhpc3RvcnkgbmF2aWdhdGlvbiBpcyBwdXNoZWQgdGhyb3VnaFxuICAjXG4gICMgIFdoZW4gc3RhdGUgY2hhbmdlIGlzIHRyaWdnZXJlZDpcbiAgIyAgICAtIHJvdXRlciBuYXZpZ2F0ZSBvY2N1cnMgaWYgdGhlIHN0YXRlIGhhcyBhbiB1cmxcbiAgIyAgICAtIGFwcHJvcHJpYXRlIHByZSBldmVudHMgKGxvYWQvdHJhbnNpdGlvbikgYXJlIHRyaWdnZXJlZCwgYm90aCBnZW5lcmljIGFuZCBzdGF0ZSBzcGVjaWZpY1xuICAjICAgIC0gbWFrZSBjYWxsIHRvIG1ldGhvZFxuICAjICAgIC0gYXBwcm9wcmlhdGUgcG9zdCBldmVudHMgKGxvYWQvdHJhbnNpdGlvbikgYXJlIHRyaWdnZXJlZCwgYm90aCBnZW5lcmljIGFuZCBzdGF0ZSBzcGVjaWZpY1xuICAjXG4gICMgIFRyaWdnZXJlZCBFdmVudHM6XG4gICMgICAgcHJlLWxvYWQgICAgICAgICAgICAgICAgIC0gaW5kaWNhdGVzIGluY29taW5nIHBhZ2UgbG9hZCBjYWxsIGZvciBhbGwgc3RhdGVzXG4gICMgICAgcHJlLWxvYWQ6W3N0YXRlXSAoYXJncykgIC0gaW5kaWNhdGVzIGluY29taW5nIHBhZ2UgbG9hZCBjYWxsIGZvciB0aGUgc3RhdGVcbiAgIyAgICBwb3N0LWxvYWQgICAgICAgICAgICAgICAgLSBpbmRpY2F0ZXMgaW5jb21pbmcgcGFnZSBsb2FkIGNhbGwgY29tcGxldGVkIGZvciBhbGwgc3RhdGVzXG4gICMgICAgcG9zdC1sb2FkOltzdGF0ZV0gKGFyZ3MpIC0gaW5kaWNhdGVzIGluY29taW5nIHBhZ2UgbG9hZCBjYWxsIGNvbXBsZXRlZCBmb3IgdGhlIHN0YXRlXG4gICNcbiAgIyAgICBwcmUtdHJhbnNpdGlvbiAgICAgICAgICAtIGluZGljYXRlcyBpbmNvbWluZyB0cmFuc2l0aW9uIGNhbGwgZm9yIGFsbCBzdGF0ZXNcbiAgIyAgICBwcmUtdHJhbnNpdGlvbjpbc3RhdGVdICAtIGluZGljYXRlcyBpbmNvbWluZyB0cmFuc2l0aW9uIGNhbGwgZm9yIHRoZSBzdGF0ZVxuICAjICAgIHBvc3QtdHJhbnNpdGlvbiAgICAgICAgIC0gaW5kaWNhdGVzIHRyYW5zaXRpb24gY2FsbCBjb21wbGV0ZWQgZm9yIGFsbCBzdGF0ZXNcbiAgIyAgICBwb3N0LXRyYW5zaXRpb246W3N0YXRlXSAtIGluZGljYXRlcyB0cmFuc2l0aW9uIGNhbGwgY29tcGxldGVkIGZvciB0aGUgc3RhdGVcbiAgI1xuICBjbGFzcyBNYW5hZ2VyXG4gICAgIyBzdGF0ZSBzdHJ1Y3R1cmU6XG4gICAgIyB7XG4gICAgIyAgICd1c2Vycyc6IHtcbiAgICAjICAgICB1cmw6ICd1c2Vycy86aWQnIChvcHRpb25hbClcbiAgICAjICAgICBsb2FkTWV0aG9kOiAnZ29Vc2VyJyAob3B0aW9uYWwpICMgZnVuY3Rpb25zIGxpa2Ugcm91dGVyLCB3aWxsIGJlIGNhbGxlZCB3aXRoIGdvVXNlcih7aWQ6IDF9KVxuICAgICMgICAgIHRyYW5zaXRpb25NZXRob2Q6ICdtb3ZlVG9Vc2VyJ1xuICAgICMgICB9XG4gICAgIyB9XG4gICAgI1xuICAgICNcbiAgICBzdGF0ZXM6IHt9XG5cbiAgICAjIGV2ZW50IHN0cnVjdHVyZSBiYXNlZCBvbiBkZWZpbmVkIE1hbmFnZXIgdHJpZ2dlcmVkIGV2ZW50c1xuICAgICMge1xuICAgICMgICAncHJlLXRyYW5zaXRpb246dXNlcnMnOiAnc2hvd0FsZXJ0J1xuICAgICMgfVxuICAgIGV2ZW50czoge31cblxuICAgIGNvbnN0cnVjdG9yOiAocm91dGVyLCBvcHRpb25zKSAtPlxuICAgICAgQHJvdXRlciA9IHJvdXRlclxuICAgICAgXy5leHRlbmQgQCwgQmFja2JvbmUuRXZlbnRzXG4gICAgICBAX3BhcnNlU3RhdGVzKClcbiAgICAgIEBfcGFyc2VFdmVudHMoKVxuICAgICAgQGluaXRpYWxpemUgb3B0aW9uc1xuICAgICAgcmV0dXJuXG5cbiAgICAjIEVtcHR5IGJ5IGRlZmF1bHQuIE92ZXJyaWRlIHdpdGggY3VzdG9tIGxvZ2ljXG4gICAgaW5pdGlhbGl6ZTogLT5cblxuICAgIF9wYXJzZVN0YXRlczogLT5cbiAgICAgIF8uZWFjaCBfLmtleXMoQHN0YXRlcyksIChzdGF0ZUtleSkgPT5cbiAgICAgICAgc3RhdGVPcHRpb25zID0gQHN0YXRlc1tzdGF0ZUtleV1cblxuICAgICAgICB1bmxlc3Mgc3RhdGVPcHRpb25zLnRyYW5zaXRpb25NZXRob2RcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Igc3RhdGVLZXkrJyBuZWVkcyB0cmFuc2l0aW9uTWV0aG9kIGRlZmluaXRpb25zJ1xuXG4gICAgICAgIGlmIHN0YXRlT3B0aW9ucy51cmxcbiAgICAgICAgICBpZiBfLmlzUmVnRXhwIHN0YXRlT3B0aW9ucy51cmxcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvciBzdGF0ZUtleSsnIGlzIG5vdCBhbGxvd2VkIHRvIGhhdmUgYSBSZWdFeHAgdXJsJ1xuXG4gICAgICAgICAgc3RhdGVPcHRpb25zLl91cmxQYXJhbXMgPSB3aGlsZSBtYXRjaGVzID0gY2FjaGVkUGFyYW1NYXRjaGVyLmV4ZWMoc3RhdGVPcHRpb25zLnVybClcbiAgICAgICAgICAgIG1hdGNoZXNbMV1cbiAgICAgICAgICBzdGF0ZU9wdGlvbnMuX3VybEFzVGVtcGxhdGUgPSBfLnRlbXBsYXRlIHN0YXRlT3B0aW9ucy51cmwsIG51bGwsIHtpbnRlcnBvbGF0ZTogY2FjaGVkUGFyYW1NYXRjaGVyfVxuICAgICAgICAgIHN0YXRlT3B0aW9ucy5fdXJsQXNSZWdleCA9IEByb3V0ZXIuX3JvdXRlVG9SZWdFeHAgc3RhdGVPcHRpb25zLnVybFxuXG4gICAgICAgICAgIyBSZWdpc3RlciB0aGUgdXJscyBpbnRvIHRoZSByb3V0ZXJcbiAgICAgICAgICBAcm91dGVyLnJvdXRlIHN0YXRlT3B0aW9ucy5fdXJsQXNSZWdleCwgc3RhdGVLZXksID0+XG4gICAgICAgICAgICBAX3JvdXRlQ2FsbGJhY2tDaG9vc2VyIHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGFyZ3VtZW50c1xuICAgICAgICAgICAgcmV0dXJuXG5cbiAgICAgICAgIyBTdGFydCBsaXN0ZW5pbmcgZm9yIG91ciBzdGF0ZSB0cmFuc2l0aW9uIGNhbGxzXG4gICAgICAgIEBsaXN0ZW5UbyBtYW5hZ2VyUXVldWUsIHN0YXRlS2V5LCAoYXJncykgPT5cbiAgICAgICAgICBAX2hhbmRsZVRyYW5zaXRpb25DYWxsYmFjayBzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzXG4gICAgICAgICAgcmV0dXJuXG4gICAgICByZXR1cm5cblxuICAgIF9yb3V0ZUNhbGxiYWNrQ2hvb3NlcjogKHN0YXRlS2V5LCBzdGF0ZU9wdGlvbnMsIGNsZWFyT25sb2FkVXJsID0gdHJ1ZSkgLT5cblxuICAgICAgIyBPbmx5IHJ1biBsb2FkQ2FsbGJhY2sgaWYgdGhpcyBpcyB0cnVseSB0aGUgdmVyeSBmaXJzdCBjYWxsYmFjayBmcm9tIHRoZSBwYWdlbG9hZCBwb3BzdGF0ZVxuICAgICAgIyBJbiBvdGhlciBjYXNlcywgQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBwb3RlbnRpYWxseSBjaGFuZ2VkIHRoZSB1cmwgZm9yIHJvdXRlciBuYXYsXG4gICAgICAjIHNvIHdlIGNoZWNrIGFnYWluc3QgaXRcbiAgICAgIGlmIG9ubG9hZFVybCBhbmQgQF9nZXRXaW5kb3dIcmVmKCkgaXMgb25sb2FkVXJsICMgdG9kbyBhOiB2ZXJpZnkgdGhpcyB3b3JrcyBjcm9zcyBicm93c2VyICYgdy8gaGFzaFxuICAgICAgICBAX2hhbmRsZUxvYWRDYWxsYmFjayBzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmd1bWVudHNcbiAgICAgIGVsc2VcbiAgICAgICAgQF9oYW5kbGVUcmFuc2l0aW9uQ2FsbGJhY2sgc3RhdGVLZXksIHN0YXRlT3B0aW9ucywgYXJndW1lbnRzLCBoaXN0b3J5SGFzVXBkYXRlZCA9IHRydWVcblxuICAgICAgaWYgY2xlYXJPbmxvYWRVcmwgdGhlbiBvbmxvYWRVcmwgPSBudWxsXG4gICAgICByZXR1cm5cblxuICAgIF9oYW5kbGVMb2FkQ2FsbGJhY2s6IChzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzKSAtPlxuICAgICAgdW5sZXNzIHN0YXRlT3B0aW9ucy5sb2FkTWV0aG9kXG4gICAgICAgIHRocm93IG5ldyBFcnJvciBzdGF0ZUtleSsnIGlzIGJlaW5nIHRyaWdnZXJlZCBmb3IgbG9hZCwgYnV0IG5vIGxvYWRNZXRob2QgaGFzIGJlZW4gZGVmaW5lZCdcblxuICAgICAgQHRyaWdnZXIgJ3ByZS1sb2FkJ1xuICAgICAgQHRyaWdnZXIgJ3ByZS1sb2FkOicrc3RhdGVLZXksIGFyZ3NcbiAgICAgIEBbc3RhdGVPcHRpb25zLmxvYWRNZXRob2RdLmFwcGx5IHRoaXMsIGFyZ3NcbiAgICAgIEB0cmlnZ2VyICdwb3N0LWxvYWQ6JytzdGF0ZUtleSwgYXJnc1xuICAgICAgQHRyaWdnZXIgJ3Bvc3QtbG9hZCdcbiAgICAgIHJldHVyblxuXG4gICAgIyBSZWFjaGVkIGluIHR3byB3YXlzOlxuICAgICMgIDEpIENhbGxiYWNrIGZyb20gcm91dGVyIHJvdXRlIGhhbmRsZVxuICAgICMgICAgYSkgYXJncyBpcyBhbiBhcnJheSBmcm9tIHRoZSByb3V0ZSBjYWxsYmFja1xuICAgICMgIDIpIGJiLXN0YXRlIGNoYW5nZSBjYWxsYmFja1xuICAgICMgICAgYSkgYXJncyBpcyB3aGF0IHRoZSB1c2VyIGhhcyBwcm92aWRlZCBkZWNsYXJhdGl2ZWx5LCBvciBpdCdzIHBhcnNlZCBmcm9tIHRoZSBsaW5rIHVybFxuICAgIF9oYW5kbGVUcmFuc2l0aW9uQ2FsbGJhY2s6IChzdGF0ZUtleSwgc3RhdGVPcHRpb25zLCBhcmdzLCBoaXN0b3J5SGFzVXBkYXRlZCA9IGZhbHNlKSAtPlxuICAgICAgQHRyaWdnZXIgJ3ByZS10cmFuc2l0aW9uJ1xuICAgICAgQHRyaWdnZXIgJ3ByZS10cmFuc2l0aW9uOicrc3RhdGVLZXlcblxuICAgICAgaWYgc3RhdGVPcHRpb25zLnVybFxuICAgICAgICAjIGFyZ3MgaXMgYW4gYXJyYXkgd2hlbjpcbiAgICAgICAgIyAgIDEpIEl0IGNvbWVzIGZyb20gYSByb3V0ZSBjYWxsYmFja1xuICAgICAgICAjICAgMikgSXMgcGFzc2VkIGFzIGFycmF5IGluIGJiLXJvdXRlIGRpcmVjdGl2ZVxuICAgICAgICAjICAgMykgSXMgaW50ZXJwb2xhdGVkIGZyb20gYSBsaW5rIHdpdGggYSB1cmwgZGVmaW5lZFxuICAgICAgICBpZiBhcmdzIGluc3RhbmNlb2YgQXJyYXlcblxuICAgICAgICAgIGFyZ3NPYmplY3QgPSBfLm9iamVjdCBzdGF0ZU9wdGlvbnMuX3VybFBhcmFtcywgYXJnc1xuXG4gICAgICAgICAgIyBQZXJmb3JtIHRoZSBvcHBvc2l0ZSBvZiByb3V0ZXMgaGFzaCBhbmQgZmlsbCBpbiB1cmwgcGFyYW1ldGVycyB3aXRoIGRhdGFcbiAgICAgICAgICB1cmwgPSBzdGF0ZU9wdGlvbnMuX3VybEFzVGVtcGxhdGUgYXJnc09iamVjdFxuXG4gICAgICAgICAgdW5sZXNzIGhpc3RvcnlIYXNVcGRhdGVkXG4gICAgICAgICAgICBAcm91dGVyLm5hdmlnYXRlIHVybFxuXG4gICAgICAgICAgZGF0YSA9IF8ubWFwIGFyZ3MsIFN0cmluZyAjIENoYW5nZSB0byBzdHJpbmcgdG8gaW1pdGF0ZVxuICAgICAgICAgIGRhdGEucHVzaCBudWxsICMgdGhpcyByZXByZXNlbnRzIHRoZSBxdWVyeSBwYXJhbXMgdmFsdWUsIHdoaWNoIHJvdXRlcnMgYWx3YXlzIGFwcGVuZCBub3dcblxuICAgICAgICBlbHNlIGlmIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgIyBhcmdzIGlzIGFsbG93ZWQgdG8gYmUgYW4gb2JqZWN0IGZvciBiYi1zdGF0ZSBkaXJlY3RpdmVzXG5cbiAgICAgICAgICAjIFBlcmZvcm0gdGhlIG9wcG9zaXRlIG9mIHJvdXRlcyBoYXNoIGFuZCBmaWxsIGluIHVybCBwYXJhbWV0ZXJzIHdpdGggZGF0YVxuICAgICAgICAgIHVybCA9IHN0YXRlT3B0aW9ucy5fdXJsQXNUZW1wbGF0ZSBhcmdzXG5cbiAgICAgICAgICB1bmxlc3MgaGlzdG9yeUhhc1VwZGF0ZWRcbiAgICAgICAgICAgIEByb3V0ZXIubmF2aWdhdGUgdXJsXG5cbiAgICAgICAgICBkYXRhID0gQHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMgc3RhdGVPcHRpb25zLl91cmxBc1JlZ2V4LCB1cmwgIyBVc2Ugcm91dGVyIHRvIGd1YXJhbnRlZSBwYXJhbSBvcmRlclxuICAgICAgICBlbHNlXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yICdBcmdzIGFyZSBvbmx5IHN1cHBvcnRlZCBhcyBhbiBvYmplY3Qgb3IgYXJyYXkgaWYgc3RhdGUudXJsIGlzIGRlZmluZWQnXG5cbiAgICAgICAgb3B0aW9ucyA9XG4gICAgICAgICAgdXJsOiB1cmxcbiAgICAgICAgZGF0YS5wdXNoIG9wdGlvbnNcbiAgICAgIGVsc2VcbiAgICAgICAgIyBub24tdXJsIGRyaXZlbiBzdGF0ZXMgbWVhbiB3ZSBwYXNzIGRhdGEgcmlnaHQgdGhyb3VnaFxuICAgICAgICBkYXRhID0gYXJnc1xuXG4gICAgICBAW3N0YXRlT3B0aW9ucy50cmFuc2l0aW9uTWV0aG9kXS5hcHBseSB0aGlzLCBkYXRhXG5cbiAgICAgIEB0cmlnZ2VyICdwb3N0LXRyYW5zaXRpb246JytzdGF0ZUtleVxuICAgICAgQHRyaWdnZXIgJ3Bvc3QtdHJhbnNpdGlvbidcbiAgICAgIHJldHVyblxuXG4gICAgX3BhcnNlRXZlbnRzOiAtPlxuICAgICAgXy5lYWNoIF8ua2V5cyhAZXZlbnRzKSwgKGV2ZW50TmFtZSkgPT5cbiAgICAgICAgQG9uIGV2ZW50TmFtZSwgQFtAZXZlbnRzW2V2ZW50TmFtZV1dXG4gICAgICAgIHJldHVyblxuICAgICAgcmV0dXJuXG5cbiAgICAjIGZvciB0ZXN0IHN0dWJzXG4gICAgX2dldFdpbmRvd0hyZWY6IC0+IHdpbmRvdz8ubG9jYXRpb24uaHJlZlxuXG4gIEJhY2tib25lLk1hbmFnZXIgPSBNYW5hZ2VyXG4gIEJhY2tib25lLk1hbmFnZXIuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kICMgdG9kbyBjOiBCZSBzbWFydGVyIGFib3V0IHRoaXMgbGF0ZXJcblxuICBfd2F0Y2hGb3JTdGF0ZUNoYW5nZSA9IC0+XG4gICAgJCgnYm9keScpLm9uICdjbGljaycsIChldmVudCkgLT5cbiAgICAgIHVubGVzcyBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKVxuICAgICAgICBpZiAkKGV2ZW50LnRhcmdldCkuYXR0cigneC1iYi1zdGF0ZScpXG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuICAgICAgICAgIHN0YXRlSW5mbyA9ICQoZXZlbnQudGFyZ2V0KS5hdHRyKCd4LWJiLXN0YXRlJykuc3BsaXQoJygnLCAyKVxuICAgICAgICAgIHN0YXRlID0gc3RhdGVJbmZvWzBdXG4gICAgICAgICAgYXJncyA9IHN0YXRlSW5mb1sxXS5zbGljZSAwLCBzdGF0ZUluZm9bMV0uaW5kZXhPZignKScpXG4gICAgICAgICAgbWFuYWdlclF1ZXVlLnRyaWdnZXIgc3RhdGUsIEpTT04ucGFyc2UoYXJncylcbiAgICAgIHJldHVyblxuXG4gICMgQmluZCB3YXRjaGVyIHRvIG9uUmVhZHlcbiAgJCBfd2F0Y2hGb3JTdGF0ZUNoYW5nZVxuICByZXR1cm5cbikoQmFja2JvbmUsIF8sICQsIHdpbmRvdylcbiJdfQ==